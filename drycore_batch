#!/bin/bash
# Use this to loop through spectral_run function
# set -e # exit if runscript triggered error

# Tasks to run
RUN=true # run the model?
POST=false # run post-processing on the model results?

# Settings for tasks
TESTING=false # do quick test control/spindown runs?
SPINDOWN=false # do spindown runs?
CONTROL=true  # do control run?
NEWEXPER=false # do not write to existing experiment directories?
NEWDAYS=true # do not write to existing dXXXX-dYYYY directories?
INIT=false # just show the initial state of model?
CLIMOSTART=600 # start climatology for post processing
CLIMOEND=2000 # end climatology day for post processing
SPINDOWNSTART=0 # start day for spindown file
SPINDOWNEND=600 # end day for spindown file

# Variables without loops
CORES=16 # core count
DAYS=100 # time step for pausing model to output results
DT=600 # time step in seconds
EXPOPT=2 # the control option; 1 for no boundary-layer timescale scaling
SPINDOWNOPT=1 # the spindown option; see run code for details

# Variables with loops
KTS=(20) # one KT for now
# KFS=(0.25 0.5 1 2 4) KAS=(10 20 40 80 160)
# KFS=(0.25 0.5 1 2 4) KAS=(10)
KFS=(1) KAS=(0.1 0.25 0.5 1 2.5 5 10 20 160 640) # some different
  # repeat KA experiments with changing boundary layer tau; weird stuff
  # starts to happen at fast timescales
NTRUNCS=(42) # truncation numbers
LEVS=(40) # vertical coordinate specifiers

# Control experiment timing
TSTART=0 # first day of integration; set to 0 for new run.
TEND=2000 # last day of integration after spin-up
TRECORD=({0000..9999}) # when to record anything at all?
TKEEP=(1000) # when to retain longitude info?

# Spindown experiment timing
TCONTROL=({17..59}00) # last time stopped at day 1500 run
TCONTROL=({10..59}00) # just one equilibrium run, for testing?
TSPINRECORD=({0000..9999}) # when to record anything at all?
TSPINKEEP=(-1) # when to keep spindown data?
TSPINSTART=0 # start day for spindown (in days after tcontrol)
TSPINEND=600 # how long to run equilibrium?
  # so an extra 500 days for each

# Post-processing options
PARALLEL=true # run post-processing stuff in parallel?
ENERGY=true # get energy?
CLIMATE=true # get the climate stuff?
EOFS=false # get EOFs?
TAU=false # get timescale estimate?
SPINDOWNAVE=false # get every record of area-averaged spindown processes?
SPINDOWNXS=false # get ensemble-mean cross-section of spindown process?
TIMESCALE=false # get the timescale?
# EQUILIBRIUM=false # get supposed "equilibrium" climate?
# DIFFS=false # get the ensemble analysis of equilibrium stuff?

# The experiment specifications
EXPNAME=hs # can be "hs", "hs", or "pk"
EXPTYPE=spectral # change this for different file
FILENAME=4xdaily_inst # name for output files
TOPOFILE= # path to file e.g. $PWD/topo.nc
  # 1 for radiation off, 2 for radiation off but surface on, 
  # 3 for everything off (radiation, surface, and friction), 4 for friction off

# Override for test experiments
if $TESTING; then # overwrite some settings
  # DAYS=1 TSTART=0 TEND=1
  DAYS=1 TSTART=2000 TEND=2003 PDIR=t42l40_d2000 # pdir is override
  # DAYS=10 TSTART=2000 TEND=2010 PDIR=t42l40_d2000 # pdir is override
  # DAYS=100 TSTART=2000 TEND=2100 PDIR=t42l40_d2000 # pdir is override
  TCONTROL=(10) TSPINSTART=0 TSPINEND=10
  # TSTART=0 TEND=1
  # TCONTROL=(10) TSPINSTART=0 TSPINEND=1
  TRECORD=({0000..9999}) TKEEP=({0000..9999}) NEWEXPER=false NEWDAYS=false
  # NTRUNCS=(42) LEVS=(era) KTS=(20) KAS=(40) KFS=(1)
  NTRUNCS=(42) LEVS=(40) KTS=(20) KAS=(40) KFS=(1)
fi

# Run multiple experiments consecutively
counter=0 # counter
parallelmax=8 # maximum parallel post-processing events
cwd=$(pwd)
for LEV in ${LEVS[@]}; do
  for NTRUNC in ${NTRUNCS[@]}; do
    for KT in ${KTS[@]}; do # stratosphere timescales
      for KA in ${KAS[@]}; do # troposphere timescales
        for KF in ${KFS[@]}; do # friction timescales
          # Ensure are still in same directory
          counter=$(($counter + 1))
          cd $cwd
          # Experiment directory
          DEFDIR="t${NTRUNC}l${LEV}_${EXPNAME}${EXPOPT}r$(printf "%08.3f" $KA)f$(printf "%08.3f" $KF)"
          if $RUN; then
            $TESTING && EXPDIR="test" || EXPDIR="$DEFDIR" # keep test model runs in special directory
            echo "Current experiment directory: ${EXPDIR}."
            case $EXPOPT in
              1) KS=4 ;; # hold boundary layer value constant
              2) KS=$(bc -l <<< "$KA/10") ;; # hold ratio constant
              3) KS=$KA ;; # constant everywhere
              4) KS=$(bc -l <<< "1/(1/4 - 1/40 + 1/$KA)") ;; # preserve 'boundary layer' component
              *) echo "ERROR: Unknown experiment option ${EXPOPT}." && exit 1 ;;
            esac
            echo "Truncation number $NTRUNC ($CORES cores). Vertical coordinates ${LEV}."
            echo "Radiation ${KA}days surface radiation ${KS}days friction ${KF}days."
            source drycore_run # can read variables declared here
          fi
          # Call post-process script
          if $POST; then
            $PARALLEL && [ $(($counter % $parallelmax)) == 0 ] \
              && echo "Waiting for spawned process." && wait
            EXPDIR="$DEFDIR" # loop have been redefined so do this once for results from one experiment
            echo "Current experiment directory: ${EXPDIR}."
            source postprocess
          fi
        done
      done
    done
  done
done
