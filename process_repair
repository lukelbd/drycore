#!/usr/bin/env bash
# Iterate through a bunch of glob patterns
# in the scratch directory
repair=./process_repair.ncl
nclcheck() { cat $1 | grep -v "Execute.c" | grep -v "systemfunc" | egrep "^fatal:" &>/dev/null; }
case ${HOSTNAME%%.*} in
  monde)
    scratch=/mdata1/ldavis
  ;; cheyenne*)
    scratch=/glade/scratch/davislu # https://www2.cisl.ucar.edu/resources/storage-and-file-systems/glade-file-spaces
  ;; *) echo "Error: Unknown host, must edit batch script before continuing." && exit 1 ;;
esac
# Loop
globs=('hs_troprad3_t95l60e*')
for glob in "${globs[@]}"; do
  for dir in $glob; do
    echo "Dir: ${dir##*/}"
    sleep 5
    filenames=($dir/netcdf/*summary*.nc)
    for filename in ${filenames[@]}; do
      echo "File: $filename"
      output=${filename%.nc}_tmp.nc # try again
      ncl -n -Q "filename=\"$filename\"" "output=\"$output\"" $repair &>log.fix #2> /dev/null
      nclcheck log.fix
      sleep 3
    done
  done
done
